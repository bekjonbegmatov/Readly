{% extends 'base.html' %}
{% block content %}
<section>
  <h1 class="text-xl font-semibold mb-3">Главная</h1>
  <div class="flex gap-2 overflow-x-auto pb-2">
    <a href="/?seg=inspire" class="px-3 py-1 rounded-full border {% if seg == 'inspire' %}bg-brand/10 text-brand border-transparent{% else %}bg-white text-gray-700{% endif %}">Вдохновляющее</a>
    <a href="/?seg=popular" class="px-3 py-1 rounded-full border {% if seg == 'popular' %}bg-brand/10 text-brand border-transparent{% else %}bg-white text-gray-700{% endif %}">Обсуждаемое</a>
    <a href="/?seg=new" class="px-3 py-1 rounded-full border {% if seg == 'new' %}bg-brand/10 text-brand border-transparent{% else %}bg-white text-gray-700{% endif %}">Новое</a>
    <a href="/?seg=psychology" class="px-3 py-1 rounded-full border {% if seg == 'psychology' %}bg-brand/10 text-brand border-transparent{% else %}bg-white text-gray-700{% endif %}">Психология</a>
    <a href="/?seg=business" class="px-3 py-1 rounded-full border {% if seg == 'business' %}bg-brand/10 text-brand border-transparent{% else %}bg-white text-gray-700{% endif %}">Бизнес</a>
  </div>
  <div id="feed" class="mt-3 space-y-2">
    {% include 'articles/_items.html' %}
  </div>
  {% if articles.has_next %}
    <div class="mt-3">
      <button id="loadMore" data-next="{{ articles.next_page_number }}" class="inline-flex items-center gap-2 rounded-md border border-gray-300 bg-white px-3 py-2 text-gray-700">
        <i data-lucide="loader" class="w-4 h-4 animate-spin hidden" id="loadSpinner"></i>
        Загрузить ещё
      </button>
    </div>
  {% endif %}
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const feed = document.getElementById('feed');
    const btn = document.getElementById('loadMore');
    const spinner = document.getElementById('loadSpinner');
    const seg = new URLSearchParams(window.location.search).get('seg') || '';

    async function loadMore(){
      if (!btn) return;
      const next = btn.dataset.next;
      if (!next) return;
      try {
        btn.disabled = true;
        spinner?.classList.remove('hidden');
        const url = `/?page=${next}&partial=1${seg ? `&seg=${encodeURIComponent(seg)}` : ''}`;
        const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        const html = await res.text();
        const temp = document.createElement('div');
        temp.innerHTML = html;
        Array.from(temp.childNodes).forEach((n) => feed.appendChild(n));
        // Обновляем номер следующей страницы
        const nextNum = parseInt(next, 10) + 1;
        // Проверяем, остались ли элементы: если меньше, чем страница, делаем попытку проверить окончание по длине
        // Упростим: сделаем дополнительный HEAD-запрос на следующую страницу, чтобы узнать есть ли ещё
        const checkUrl = `/?page=${nextNum}&partial=1${seg ? `&seg=${encodeURIComponent(seg)}` : ''}`;
        const checkRes = await fetch(checkUrl, { method: 'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        const checkHtml = (await checkRes.text()).trim();
        if (!checkHtml || checkHtml === '' || checkHtml.includes('Пока нет статей')){
          btn.remove();
        } else {
          btn.dataset.next = String(nextNum);
          btn.disabled = false;
        }
      } catch (e){
        btn.disabled = false;
      } finally {
        spinner?.classList.add('hidden');
      }
    }
    btn?.addEventListener('click', loadMore);
    // Автоподгрузка: когда кнопка видима, загружаем следующую страницу
    if (btn && 'IntersectionObserver' in window){
      const io = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting && !btn.disabled){
            loadMore();
          }
        });
      }, { rootMargin: '200px' });
      io.observe(btn);
    }
  });
</script>

<section class="mt-6">
  <h1 class="text-xl font-semibold mb-3">Результаты</h1>
  <div class="space-y-2">
    {% for r in recommended %}
      <article class="p-3 border border-gray-200 rounded-xl bg-white shadow-soft flex items-start gap-3">
        <div class="w-16 h-16 rounded-md border border-gray-200 bg-gray-100 flex items-center justify-center"><i data-lucide="image" class="w-5 h-5 text-gray-400"></i></div>
        <div class="flex-1">
          <h3 class="text-base font-semibold leading-snug"><a class="hover:text-brand" href="/article/{{ r.pk }}/">{{ r.title }}</a></h3>
          <p class="text-gray-500 text-sm"><a class="hover:text-brand" href="/u/{{ r.author.username }}/">@{{ r.author.username }}</a></p>
          <p class="text-gray-500 text-xs flex items-center gap-3 mt-1">
            <span class="inline-flex items-center gap-1"><i data-lucide="heart" class="w-4 h-4"></i> {{ r.likes_count }}</span>
            <span class="inline-flex items-center gap-1"><i data-lucide="message-circle" class="w-4 h-4"></i> {{ r.comments_count }}</span>
          </p>
        </div>
        <a href="/article/{{ r.pk }}/favorite/" class="text-gray-400 hover:text-brand" aria-label="В избранное"><i data-lucide="bookmark" class="w-5 h-5"></i></a>
      </article>
    {% empty %}
      <p class="text-gray-500">Пока нет рекомендаций.</p>
    {% endfor %}
  </div>
</section>
{% endblock %}